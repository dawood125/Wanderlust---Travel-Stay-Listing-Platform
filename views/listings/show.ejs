<% layout("/layouts/boilerplate") %>

<div class="listing-details">
  <h3><%= listing.title %></h3>

  <div class="listing-image">
    <img src="<%= listing.image.url %>" alt="<%= listing.title %>" />
  </div>

  <div class="listing-info">
    <ul>
      <li>
        <strong>Description:</strong>
        <%= listing.description %>
      </li>
      <li>
        <strong>Price:</strong>
        <span class="price"
          >&#8377; <%= listing.price.toLocaleString("en-IN") %></span
        >
      </li>
      <li>
        <strong>Location:</strong>
        <%= listing.location %>
      </li>
      <li>
        <strong>Country:</strong>
        <%= listing.country %>
      </li>
      <li>
        <strong>Owned by:</strong>
        <%= listing.owner.username %>
      </li>
    </ul>
  </div>

  <% if (currUser && currUser.equals(listing.owner)) {%>
  <div class="listing-actions">
    <a href="/listings/<%= listing._id %>/edit" class="btn-custom edit-btn"
      >Edit</a
    >
    <form action="/listings/<%= listing._id %>?_method=DELETE" method="post">
      <button class="btn-custom delete-btn">Delete</button>
    </form>
  </div>
  <%} %>
</div>

<% if (currUser) {%>
<div class="col-md-8 offset-2">
  <h4 class="text-center my-md-3">Leave a reveiw</h4>

  <form
    action="/listings/<%= listing._id %>/reviews"
    method="post"
    novalidate
    class="needs-validation"
  >
    <!-- <div>
      <label for="rating">Rating</label>
      <input
        type="range"
        min="1"
        max="5"
        name="review[rating]"
        id="rating"
        class="form-range border-0"
      />
    </div> -->

    <label for="rating">Rating</label>
    <fieldset class="starability-slot mt-md-4">
      <input
        type="radio"
        id="no-rate"
        class="input-no-rate"
        name="review[rating]"
        value="1"
        checked
        aria-label="No rating."
      />
      <input type="radio" id="first-rate1" name="review[rating]" value="1" />
      <label for="first-rate1" title="Terrible">1 star</label>
      <input type="radio" id="first-rate2" name="review[rating]" value="2" />
      <label for="first-rate2" title="Not good">2 stars</label>
      <input type="radio" id="first-rate3" name="review[rating]" value="3" />
      <label for="first-rate3" title="Average">3 stars</label>
      <input type="radio" id="first-rate4" name="review[rating]" value="4" />
      <label for="first-rate4" title="Very good">4 stars</label>
      <input type="radio" id="first-rate5" name="review[rating]" value="5" />
      <label for="first-rate5" title="Amazing">5 stars</label>
    </fieldset>
    <div>
      <label for="comment">Comments</label>
      <textarea
        name="review[comment]"
        id="comment"
        required
        cols="30"
        rows="5"
        class="form-control"
      ></textarea>
      <div class="invalid-feedback">Please add some comment for the review</div>
    </div>
    <button class="rounded mt-md-4">Submit</button>
  </form>
</div>
<%} %>
<div class="reviews-section mt-5">
  <h4 class="text-center mb-4">Customer Reviews</h4>

  <% if (listing.reviews.length===0) { %>
  <p class="text-center text-muted">
    No reviews yet. Be the first to leave one!
  </p>
  <% } else { %>
  <div class="row g-4">
    <% listing.reviews.forEach(review=> { %>
    <div class="col-md-6">
      <div class="card shadow-sm border-0 h-100 rounded-3">
        <div class="card-body">
          <div class="card-title">@<%= review.author.username %></div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="review-rating">
              <% for (let i=1; i <=5; i++) { %> <% if (i <=review.rating) { %>
              <span class="star text-warning">&#9733;</span>
              <% } else { %>
              <span class="star text-muted">&#9734;</span>
              <% } %> <% } %>
            </div>
            <form
              action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
              method="POST"
            >
              <button class="btn btn-sm btn-outline-danger">
                <i class="fa fa-trash"></i>
              </button>
            </form>
          </div>
          <p class="review-comment"><%= review.comment %></p>
          <small class="text-muted">
            Posted on <%= review.createdAt.toDateString() %>
          </small>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
  <% } %>
</div>
<h1 class="pt-md-4">Where you will be:</h1>
<div
  id="map"
  style="height: 500px; width: 100%; border-radius: 10px; margin-top: 20px"
></div>
<script>
  async function getCoordinates(location) {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
        location
      )}`
    );
    const data = await response.json();
    return data.length > 0 ? [data[0].lat, data[0].lon] : null;
  }

  const locationText = "<%= listing.location %> ";

  getCoordinates(locationText).then((coords) => {
    const mapContainer = document.getElementById("map");
    if (!coords) {
      mapContainer.innerHTML = `
        <div style="text-align:center; padding:40px; color:#555;">
          <i class="fa fa-map-marker-alt fa-3x mb-3"></i>
          <h5>Map not available for this location</h5>
          <p>Please check the spelling or update the location.</p>
        </div>`;
      mapContainer.style.background = "#f8f9fa";
      mapContainer.style.border = "1px solid #ddd";
      return;
    }

    const map = L.map("map").setView(coords, 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    L.marker(coords).addTo(map).bindPopup("<%= listing.title %>").openPopup();
  });
</script>
